#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-push checks..."
echo ""

# Get current branch name
BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo "ğŸ“ Branch: $BRANCH"
echo ""

# 1. Linting
echo "ğŸ” Running ESLint..."
npm run lint
if [ $? -ne 0 ]; then
  echo "âŒ Linting failed!"
  echo "Run 'npm run lint:fix' to fix auto-fixable issues."
  exit 1
fi
echo "âœ… Linting passed!"
echo ""

# 2. Type checking
echo "ğŸ” Running TypeScript type check..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "âŒ Type check failed!"
  echo "Fix TypeScript errors before pushing."
  exit 1
fi
echo "âœ… Type check passed!"
echo ""

# 3. Unit tests (optional - can skip if there are known failures)
if [ "$SKIP_TESTS" = "1" ]; then
  echo "â­ï¸  Skipping unit tests (SKIP_TESTS=1)"
  echo "âš ï¸  Warning: Make sure your changes don't break existing functionality!"
else
  echo "ğŸ§ª Running unit tests..."
  npm run test -- --ci --watchAll=false
  if [ $? -ne 0 ]; then
    echo "âŒ Unit tests failed!"
    echo ""
    echo "Options:"
    echo "  1. Fix the failing tests"
    echo "  2. Skip tests with: SKIP_TESTS=1 git push"
    echo "     (Use only if failures are pre-existing)"
    echo ""
    exit 1
  fi
  echo "âœ… Unit tests passed!"
fi
echo ""

# 4. E2E tests (conditional based on branch)
if [ "$SKIP_E2E" = "1" ]; then
  echo "â­ï¸  Skipping E2E tests (SKIP_E2E=1)"
elif [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ] || [ "$BRANCH" = "develop" ]; then
  echo "ğŸ­ Running E2E tests (critical branch: $BRANCH)..."
  npm run e2e
  if [ $? -ne 0 ]; then
    echo "âŒ E2E tests failed!"
    echo "Fix E2E tests before pushing to $BRANCH."
    exit 1
  fi
  echo "âœ… E2E tests passed!"
else
  echo "âš¡ Skipping E2E tests for feature branch"
  echo "   Run manually with 'npm run e2e' before merging"
fi

echo ""
echo "âœ… All pre-push checks passed! Pushing to remote..."
echo ""
